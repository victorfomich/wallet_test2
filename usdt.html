<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>USDT</title>
  <link rel="stylesheet" href="./styles.css" />
  <link rel="stylesheet" href="./usdt.css" />
  <meta name="color-scheme" content="light" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;margin:0;padding:16px;background:#f8fafc;color:#0f172a}
    header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tabs button{padding:8px 12px;border:1px solid #cbd5e1;background:#fff;border-radius:8px;cursor:pointer}
    .tabs button.active{background:#111827;color:#fff;border-color:#111827}
    .search{margin:8px 0}
    input[type="text"]{padding:8px;border:1px solid #cbd5e1;border-radius:8px;width:100%;max-width:420px}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden}
    th,td{border-bottom:1px solid #e5e7eb;padding:10px 12px;text-align:left;font-size:14px}
    th{background:#f1f5f9}
    .muted{color:#64748b;font-size:12px}
    .wrap{word-break:break-all}
    
    /* Toast notification styles */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 1000;
      transform: translateX(400px);
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }
    
    .toast-icon {
      width: 24px;
      height: 24px;
      background: #10b981;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .toast-icon svg {
      width: 14px;
      height: 14px;
      fill: #fff;
    }
    
    .toast-text {
      font-size: 14px;
      font-weight: 500;
      color: #111827;
    }
  </style>
</head>
<body>
  <div class="asset-view small">
    <header class="asset-header" style="padding:16px;">
      <button id="assetBack" class="asset-back" aria-label="Назад" style="color: rgba(107,114,128,0.6);">
        <svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true">
          <path d="M15 6L9 12l6 6" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <div class="asset-title">USDT</div>
    </header>
    <div class="asset-body">
      <div class="asset-icon"><img src="usdt-icon.png" alt="USDT" class="asset-logo" /></div>
      <div class="asset-amount">0.0 USDT</div>
      <div class="asset-amount-sub">0.0 ₽</div>
    </div>
    <div class="asset-ctas">
      <div class="cta-item">
        <button class="qr-btn" aria-label="Пополнить">
          <img src="plus-icon.png" alt="Plus" class="qr-img" width="28" height="28" />
        </button>
        <div class="cta-label">Пополнить</div>
      </div>
      <div class="cta-item">
        <button class="qr-btn" aria-label="Отправить">
          <img src="arrow-icon.png" alt="Arrow" class="qr-img" width="28" height="28" />
        </button>
        <div class="cta-label">Отправить</div>
      </div>
      <div class="cta-item">
        <button class="qr-btn" aria-label="Продать">
          <img src="sell-icon.png" alt="Sell" class="qr-img" width="28" height="28" />
        </button>
        <div class="cta-label">Продать</div>
      </div>
      <div class="cta-item">
        <button class="qr-btn" aria-label="Оплатить">
          <img src="basket-icon.png" alt="Basket" class="qr-img" width="28" height="28" />
        </button>
        <div class="cta-label">Оплатить</div>
      </div>
    </div>

    <div class="asset-card">
      <div class="card-main">
        <div class="card-icon">
          <div class="card-icon-circle"><img src="usdt-icon.png" alt="USDT" class="card-logo" />
          </div>
        </div>
        <div class="card-info">
          <div class="card-title">USDT <span class="chain-pill">TRC20</span></div>
          <div class="card-address" id="trc20Address">TEoXJFZ...sKcT9Pz</div>
        </div>
        <div class="card-actions">
          <button class="icon-btn" aria-label="Показать QR">
            <img src="qr2-icon.png" alt="QR" width="27" height="27" />
          </button>
          <button class="icon-btn" aria-label="Копировать адрес">
            <img src="copy-icon.png" alt="QR" width="27" height="27" />
          </button>
        </div>
      </div>
      <div class="card-fee">Комиссия: 2.75 USDT</div>
    </div>

    <div class="asset-card">
      <div class="card-main">
        <div class="card-icon">
          <div class="card-icon-circle"><img src="usdt-icon.png" alt="USDT" class="card-logo" />
          </div>
        </div>
        <div class="card-info">
          <div class="card-title">USDT <span class="chain-pill">TON</span></div>
          <div class="card-address" id="tonAddress">TEoXJFZ...sKcT9Pz</div>
        </div>
        <div class="card-actions">
          <button class="icon-btn" aria-label="Показать QR">
            <img src="qr2-icon.png" alt="QR" width="27" height="27" />
          </button>
          <button class="icon-btn" aria-label="Копировать адрес">
            <img src="copy-icon.png" alt="QR" width="27" height="27" />
          </button>
        </div>
      </div>
      <div class="card-fee">Комиссия: 0 USDT</div>
    </div>

  </div>
  <script>
    // Back behavior
    (function(){
      const btn = document.getElementById('assetBack');
      btn.addEventListener('click', () => {
        if (window.history.length > 1) window.history.back(); else window.location.href = 'index.html';
      });
      try { const wa = window.Telegram?.WebApp; wa?.BackButton?.show(); wa?.BackButton?.onClick(() => btn.click()); } catch(e) {}
      // haptics on cta buttons
      document.querySelectorAll('.asset-ctas .qr-btn').forEach(el => {
        el.addEventListener('click', () => { try { window.Telegram?.WebApp?.HapticFeedback?.impactOccurred('light'); } catch(e) {} });
      });
    })();

    // Format address: first 7 + ... + last 7
    function formatAddress(addr) {
      if (!addr || addr.length < 14) return addr;
      return addr.slice(0, 7) + '...' + addr.slice(-7);
    }

    // Show assigned addresses
    (async () => {
      try {
        const wa = window.Telegram?.WebApp;
        const initData = wa?.initData || '';
        const uid = wa?.initDataUnsafe?.user?.id ? String(wa.initDataUnsafe.user.id) : (localStorage.getItem('tonAssignedUserId') || null);
        
        // TON address
        const tonEl = document.getElementById('tonAddress');
        if (tonEl) {
          const addrLS = localStorage.getItem('tonAssignedAddress');
          if (addrLS && uid) { 
            tonEl.textContent = formatAddress(addrLS); 
            return; 
          }
          // Fallback: call register
          const bodyUid = uid || `anon-${Math.random().toString(36).slice(2)}-${Date.now()}`;
          const res = await fetch('/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Telegram-Init-Data': initData },
            body: JSON.stringify({ user_id: bodyUid })
          });
          if (res.ok) {
            const data = await res.json();
            if (data?.address) {
              tonEl.textContent = formatAddress(data.address);
              localStorage.setItem('tonAssignedAddress', data.address);
              localStorage.setItem('tonAssignedUserId', bodyUid);
            }
          }
        }

        // TRC20 address (placeholder for now)
        const trc20El = document.getElementById('trc20Address');
        if (trc20El) {
          trc20El.textContent = 'TEoXJFZ...sKcT9Pz'; // placeholder
        }
      } catch (_) {}
    })();

    // Copy address functionality
    function copyToClipboard(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          showToast('Адрес скопирован');
        }).catch(() => {
          // Fallback for older browsers
          fallbackCopyTextToClipboard(text);
        });
      } else {
        fallbackCopyTextToClipboard(text);
      }
    }

    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        document.execCommand('copy');
        showToast('Адрес скопирован');
      } catch (err) {
        console.error('Fallback: Oops, unable to copy', err);
      }
      document.body.removeChild(textArea);
    }

    // Toast notification function
    function showToast(message) {
      // Remove existing toast if any
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }

      // Create new toast
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `
        <div class="toast-icon">
          <svg viewBox="0 0 24 24">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
          </svg>
        </div>
        <div class="toast-text">${message}</div>
      `;

      document.body.appendChild(toast);

      // Trigger animation
      setTimeout(() => {
        toast.classList.add('show');
      }, 10);

      // Hide after 1.5 seconds
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }, 1500);
    }

    // Add copy button handlers
    document.addEventListener('DOMContentLoaded', () => {
      // TON copy button
      const tonCopyBtn = document.querySelector('#tonAddress').closest('.asset-card').querySelector('button[aria-label="Копировать адрес"]');
      if (tonCopyBtn) {
        tonCopyBtn.addEventListener('click', () => {
          const fullAddr = localStorage.getItem('tonAssignedAddress');
          if (fullAddr) {
            copyToClipboard(fullAddr);
          }
        });
      }

      // TRC20 copy button (placeholder for now)
      const trc20CopyBtn = document.querySelector('#trc20Address').closest('.asset-card').querySelector('button[aria-label="Копировать адрес"]');
      if (trc20CopyBtn) {
        trc20CopyBtn.addEventListener('click', () => {
          // For now, copy placeholder text
          copyToClipboard('TEoXJFZ...sKcT9Pz');
        });
      }
    });
  </script>
</body>
</html>


