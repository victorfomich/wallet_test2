<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>USDT</title>
  <link rel="stylesheet" href="./styles.css" />
  <link rel="stylesheet" href="./usdt.css" />
  <meta name="color-scheme" content="light" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="asset-view small">
    <header class="asset-header" style="padding:16px;">
      <button id="assetBack" class="asset-back" aria-label="Назад" style="color: rgba(107,114,128,0.6);">
        <svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true">
          <path d="M15 6L9 12l6 6" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <div class="asset-title">USDT</div>
    </header>
    <div class="asset-body">
      <div class="asset-icon"><img src="usdt-icon.png" alt="USDT" class="asset-logo" /></div>
      <div class="asset-amount">0.0 USDT</div>
      <div class="asset-amount-sub">0.0 ₽</div>
    </div>
    <div class="asset-ctas">
      <div class="cta-item">
        <button class="qr-btn" aria-label="Пополнить">
          <img src="plus-icon.png" alt="Plus" class="qr-img" width="28" height="28" />
        </button>
        <div class="cta-label">Пополнить</div>
      </div>
      <div class="cta-item">
        <button class="qr-btn" aria-label="Отправить">
          <img src="arrow-icon.png" alt="Arrow" class="qr-img" width="28" height="28" />
        </button>
        <div class="cta-label">Отправить</div>
      </div>
      <div class="cta-item">
        <button class="qr-btn" aria-label="Продать">
          <img src="sell-icon.png" alt="Sell" class="qr-img" width="28" height="28" />
        </button>
        <div class="cta-label">Продать</div>
      </div>
      <div class="cta-item">
        <button class="qr-btn" aria-label="Оплатить">
          <img src="basket-icon.png" alt="Basket" class="qr-img" width="28" height="28" />
        </button>
        <div class="cta-label">Оплатить</div>
      </div>
    </div>

    <div class="asset-card">
      <div class="card-main">
        <div class="card-icon">
          <div class="card-icon-circle"><img src="usdt-icon.png" alt="USDT" class="card-logo" />
          </div>
        </div>
        <div class="card-info">
          <div class="card-title">USDT <span class="chain-pill">TRC20</span></div>
          <div class="card-address" id="trc20Address">TEoXJFZ...sKcT9Pz</div>
        </div>
        <div class="card-actions">
          <button class="icon-btn" aria-label="Показать QR">
            <img src="qr2-icon.png" alt="QR" width="27" height="27" />
          </button>
          <button class="icon-btn" aria-label="Копировать адрес">
            <img src="copy-icon.png" alt="QR" width="27" height="27" />
          </button>
        </div>
      </div>
      <div class="card-fee">Комиссия: 2.75 USDT</div>
    </div>

    <div class="asset-card">
      <div class="card-main">
        <div class="card-icon">
          <div class="card-icon-circle"><img src="usdt-icon.png" alt="USDT" class="card-logo" />
          </div>
        </div>
        <div class="card-info">
          <div class="card-title">USDT <span class="chain-pill">TON</span></div>
          <div class="card-address" id="tonAddress">TEoXJFZ...sKcT9Pz</div>
        </div>
        <div class="card-actions">
          <button class="icon-btn" aria-label="Показать QR">
            <img src="qr2-icon.png" alt="QR" width="27" height="27" />
          </button>
          <button class="icon-btn" aria-label="Копировать адрес">
            <img src="copy-icon.png" alt="QR" width="27" height="27" />
          </button>
        </div>
      </div>
      <div class="card-fee">Комиссия: 0 USDT</div>
    </div>

  </div>
  <script>
    // Back behavior
    (function(){
      const btn = document.getElementById('assetBack');
      btn.addEventListener('click', () => {
        if (window.history.length > 1) window.history.back(); else window.location.href = 'index.html';
      });
      try { const wa = window.Telegram?.WebApp; wa?.BackButton?.show(); wa?.BackButton?.onClick(() => btn.click()); } catch(e) {}
      // haptics on cta buttons
      document.querySelectorAll('.asset-ctas .qr-btn').forEach(el => {
        el.addEventListener('click', () => { try { window.Telegram?.WebApp?.HapticFeedback?.impactOccurred('light'); } catch(e) {} });
      });
    })();

    // Format address: first 7 + ... + last 7
    function formatAddress(addr) {
      if (!addr || addr.length < 14) return addr;
      return addr.slice(0, 7) + '...' + addr.slice(-7);
    }

    // Show assigned addresses
    (async () => {
      try {
        const wa = window.Telegram?.WebApp;
        const initData = wa?.initData || '';
        const uid = wa?.initDataUnsafe?.user?.id ? String(wa.initDataUnsafe.user.id) : (localStorage.getItem('tonAssignedUserId') || null);
        
        // TON address
        const tonEl = document.getElementById('tonAddress');
        if (tonEl) {
          const addrLS = localStorage.getItem('tonAssignedAddress');
          if (addrLS && uid) { 
            tonEl.textContent = formatAddress(addrLS); 
            return; 
          }
          // Fallback: call register
          const bodyUid = uid || `anon-${Math.random().toString(36).slice(2)}-${Date.now()}`;
          const res = await fetch('/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Telegram-Init-Data': initData },
            body: JSON.stringify({ user_id: bodyUid })
          });
          if (res.ok) {
            const data = await res.json();
            if (data?.address) {
              tonEl.textContent = formatAddress(data.address);
              localStorage.setItem('tonAssignedAddress', data.address);
              localStorage.setItem('tonAssignedUserId', bodyUid);
            }
          }
        }

        // TRC20 address (placeholder for now)
        const trc20El = document.getElementById('trc20Address');
        if (trc20El) {
          trc20El.textContent = 'TEoXJFZ...sKcT9Pz'; // placeholder
        }
      } catch (_) {}
    })();

    // Copy address functionality
    function copyToClipboard(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          // Visual feedback
          const event = new CustomEvent('addressCopied', { detail: { text } });
          document.dispatchEvent(event);
        }).catch(() => {
          // Fallback for older browsers
          fallbackCopyTextToClipboard(text);
        });
      } else {
        fallbackCopyTextToClipboard(text);
      }
    }

    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        document.execCommand('copy');
        const event = new CustomEvent('addressCopied', { detail: { text } });
        document.dispatchEvent(event);
      } catch (err) {
        console.error('Fallback: Oops, unable to copy', err);
      }
      document.body.removeChild(textArea);
    }

    // Add copy button handlers
    document.addEventListener('DOMContentLoaded', () => {
      // TON copy button
      const tonCopyBtn = document.querySelector('#tonAddress').closest('.asset-card').querySelector('button[aria-label="Копировать адрес"]');
      if (tonCopyBtn) {
        tonCopyBtn.addEventListener('click', () => {
          const fullAddr = localStorage.getItem('tonAssignedAddress');
          if (fullAddr) {
            copyToClipboard(fullAddr);
          }
        });
      }

      // TRC20 copy button (placeholder for now)
      const trc20CopyBtn = document.querySelector('#trc20Address').closest('.asset-card').querySelector('button[aria-label="Копировать адрес"]');
      if (trc20CopyBtn) {
        trc20CopyBtn.addEventListener('click', () => {
          // For now, copy placeholder text
          copyToClipboard('TEoXJFZ...sKcT9Pz');
        });
      }
    });

    // Visual feedback when address is copied
    document.addEventListener('addressCopied', (e) => {
      const btn = event.target;
      if (btn && btn.tagName === 'BUTTON') {
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span style="color: #10b981;">✓</span>';
        setTimeout(() => {
          btn.innerHTML = originalText;
        }, 1000);
      }
    });
  </script>
</body>
</html>


